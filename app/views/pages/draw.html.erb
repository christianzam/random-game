<div class="flex justify-center px-5" data-controller="draw">
  <div class="w-full p-4 text-center bg-white border border-gray-200 rounded-lg shadow sm:p-8 dark:bg-gray-800 dark:border-gray-700">
    <h5 class="mb-2 text-3xl font-bold text-gray-900 dark:text-white">Turnos</h5>
    <p class="mb-5 text-base text-gray-500 sm:text-lg dark:text-gray-400">
      <% if @game.present? %>
        Juego <%= @game.date.strftime("%A %d %B %Y") %>
      <% end %>
    </p>
    <!-- Button draw -->
    <div class="flex justify-center my-5">
      <%= button_tag 'Hacer rifa',
        id: "shuffleButton",
        class: 'w-1/3 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800',
        data: { draw_target: 'shuffleBtn', action: 'click->draw#insertUsersToTable' }
      %>
    </div>

    <!-- Progress bar -->
    <div class="flex justify-between my-5">
      <span class="text-base font-medium text-blue-700 dark:text-white" id="startingLabel"></span>
      <span class="text-sm font-medium text-blue-700 dark:text-white" id="endingLabel"></span>
    </div>
    <div class="w-full bg-gray-100 rounded-full h-2.5 dark:bg-gray-700">
      <div class="bg-blue-600 h-2.5 rounded-full" id="progressNum"></div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-3 gap-1 mt-5">
      <div class="w-full max-w-md bg-gray-300 border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
        <div class="justify-center">
          <h2 class="text-lg font-bold mb-2 js-pre-title hidden">Primera rifa</h2>
          <table class="w-full text-1xl text-left text-gray-500 dark:text-gray-400 pre-shuffle hidden" style="filter: brightness(.5);">
            <tbody>
              <!-- Display the pre-shuffle results here -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="w-full max-w-md bg-gray-300 border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
        <h2 class="text-lg font-bold mb-2 js-test-title hidden">Segunda rifa</h2>
        <table class="w-full text-1xl text-left text-gray-500 dark:text-gray-400 test-shuffle hidden" style="filter: brightness(.5);">
          <tbody>
            <!-- Display the test-shuffle results here -->
          </tbody>
        </table>
      </div>
      <div class="w-full max-w-md bg-gray-300 border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
        <h2 class="text-lg font-bold mb-2 js-final-title hidden">Turnos</h2>
        <table class="w-full text-3xl text-left text-gray-500 dark:text-gray-400 final-shuffle hidden">
          <tbody>
            <!-- Display the final-shuffle results here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const shuffleButton = document.getElementById("shuffleButton");
    const preShuffleTable = document.querySelector(".pre-shuffle");
    const testShuffleTable = document.querySelector(".test-shuffle");
    const finalShuffleTable = document.querySelector(".final-shuffle");

    const preTitle = document.querySelector(".js-pre-title");
    const testTitle = document.querySelector(".js-test-title");
    const finalTitle = document.querySelector(".js-final-title");
    
    const startingLabel = document.getElementById("startingLabel");
    const endingLabel = document.getElementById("endingLabel");
    const progressNum = document.getElementById('progressNum');
    progressNum.style.width = '0%';

    let first_shuffle = ['Lalo', 'Cristina', 'Alex', 'Diego', 'Kike', 'Erikniu', 'Pato', 'Axelito', 'BackEndJr', 'Manu', 'Majo', 'Xoch', 'Sergio'].sort(() => Math.random() - 0.6);
    let second_shuffle = ['Lalo', 'Cristina', 'Alex', 'Diego', 'Kike', 'Erikniu', 'Pato', 'Axelito', 'BackEndJr', 'Manu', 'Majo', 'Xoch', 'Sergio'].sort(() => Math.random() - 0.6);
    let third_shuffle = ['Lalo', 'Cristina', 'Alex', 'Diego', 'Kike', 'Erikniu', 'Pato', 'Axelito', 'BackEndJr', 'Manu', 'Majo', 'Xoch', 'Sergio'].sort(() => Math.random() - 0.6);

    const results = [
      first_shuffle,
      second_shuffle,
      third_shuffle
    ];

    let shuffleIndex = 0;

    shuffleButton.addEventListener("click", function() {
      if (shuffleIndex === 0) {
        preShuffleTable.classList.remove("hidden");
        preTitle.classList.remove("hidden");
        displayResults(preShuffleTable, results[shuffleIndex]);
        shuffleButton.textContent = "2nda Rifa";
        startingLabel.innerHTML = 'Comienzo'
        progressNum.style.width = '33%';

      } else if (shuffleIndex === 1) {
        testShuffleTable.classList.remove("hidden");
        testTitle.classList.remove("hidden");
        displayResults(testShuffleTable, results[shuffleIndex]);
        shuffleButton.textContent = "Rifa Final";
        progressNum.style.width = '66%';

      } else if (shuffleIndex === 2) {
        finalShuffleTable.classList.remove("hidden");
        finalTitle.classList.remove("hidden");
        displayResults(finalShuffleTable, results[shuffleIndex]);
        shuffleButton.style.display = "none";
        endingLabel.innerHTML = 'Rifa Completa'
        progressNum.style.width = '100%';
      }

      shuffleIndex++;
  });

  function displayResults(table, results) {
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";

    results.forEach(function(result, index) {
      const row = document.createElement("tr");
      row.className = "bg-white border-b dark:bg-gray-800 dark:border-gray-700";

      const numberCell = document.createElement("th");
      numberCell.scope = "row";
      numberCell.className = "px-6 py-4 font-large text-gray-900 whitespace-nowrap dark:text-white";
      numberCell.textContent = index + 1 + ". ";

      const nameCell = document.createElement("td");
      nameCell.className = "px-6 py-4";
      nameCell.textContent = result;

      row.appendChild(numberCell);
      row.appendChild(nameCell);

      tbody.appendChild(row);
    });
  }
});
</script>
